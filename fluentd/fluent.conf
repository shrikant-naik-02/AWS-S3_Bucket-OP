<source>
  @type tail
  path /app/logs/spring-boot-app.log
  pos_file /fluentd/log/spring-boot-app.pos
  tag springboot.app

  <parse>
    @type multiline
    format_firstline /^\s*\{/
    format1 /^\s*(?<json>.+)/
  </parse>

</source>

<filter springboot.app>
  @type parser
  key_name json
  format json
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S%z
  reserve_data true
  remove_key_name_field true
</filter>

<filter springboot.app>
  @type record_transformer
  enable_ruby true
  <record>
    version 1.1
    host "#{Socket.gethostname}"
    short_message ${message}
    timestamp ${time.to_f}
  </record>
</filter>


<match springboot.app>
  @type gelf
  host graylog         # must match the docker-compose service name
  port 12201
  flush_interval 1s
  protocol udp
  gelf_level info      # or use dynamic mapping if needed
</match>
